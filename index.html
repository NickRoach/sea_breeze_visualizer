<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weather Stations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #controls { padding: 8px; }
    #map { height: calc(100% - 44px); }
    input { width: 80%; padding: 6px; }
    button { padding: 6px 10px; }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map("map").setView([0, 0], 2);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors",
    maxZoom: 19
  }).addTo(map);

  const layer = L.layerGroup().addTo(map);

  loadData();

  function fToC(f) {
    return (f - 32) * 5 / 9;
  }

  function getLatLon(feature) {
    const c = feature?.geometry?.coordinates;
    if (!Array.isArray(c) || c.length < 2) return null;
    return [c[1], c[0]]; // [lat, lon]
  }

  // Linear gradient from blue (15°C) to red (30°C)
  function tempToColor(tempC) {
    if (tempC === null) return "#888";

    const tMin = 15;
    const tMax = 30;

    // clamp outside range
    const t = Math.min(tMax, Math.max(tMin, tempC));
    const f = (t - tMin) / (tMax - tMin); // 0..1

    const r = Math.round(255 * f);
    const g = Math.round(64 * (1 - f));
    const b = Math.round(255 * (1 - f));

    return `rgb(${r},${g},${b})`;
  }

  async function loadData() {

    layer.clearLayers();


    const features = await getData();
    const points = [];

    for (const f of features) {
      const ll = getLatLon(f);
      if (!ll) continue;

      const p = f.properties || {};
      const tempC = (typeof p.tempf === "number") ? fToC(p.tempf) : null;
      const hum   = (typeof p.humidity === "number") ? p.humidity : null;

      L.circleMarker(ll, {
        radius: 9,
        fillColor: tempToColor(tempC),
        color: "#000",
        weight: 1,
        fillOpacity: 0.85
      })
      .bindPopup(
        `<strong>${p.neighborhood ?? "Station"}</strong><br>
         Temp: ${tempC !== null ? tempC.toFixed(1) : "—"} °C<br>
         Humidity: ${hum !== null ? hum : "—"} %`
      )
      .addTo(layer);

      points.push(ll);
    }

    if (points.length) {
      map.fitBounds(points, { padding: [20, 20] });
    }
  }

  async function getData(){
    const startX = 1879;
    const startY = 1226;

    let features = [];

    for(x=startX; x<=startX+2; x++){
      for(y=startY; y<=startY+2; y++){
        const url = `https://api.weather.com/v2/vector-api/products/614/features?x=${x}&y=${y}&lod=12&apiKey=e1f10a1e78da46f5b10a1e78da96f525&tile-size=512&time=1766398500000-1766399400000`;
        const res = await fetch(url);
        const data = await res.json();
        features = features.concat(data.features);
      }
    }
    return features;
  }
</script>

</body>
</html>
